# ppychen
手术访视是手术麻醉管理的中枢，本文针对传统手术访视复杂的流程进行手术访视管理系统子系统的设计，该系统总体上具备了无纸化的低耗性、总体流程控制的简单便捷性和易维护性的优点，本系统实现了访视医生根据手术拟开始时间的前一天允许选择患者创建线上会议或基于弗洛伊德算法推荐最短路径的线下访视，对线上会议进行图片检测是否存在二维码的广告的插入和语音识别是否有违禁词语，管理访视资料库等功能。本系统设计以.Net 三层和 User Control 为主要架构，结合数据库和网络通信技术在vs2019提供的Framework 4.0和Window系统进行开发设计。本文根据软件工程的框架，详细论述本系统的具体设计的需求、流程控制的各个阶段功能，有益于推动智慧医院的建设。
## 具体
本系统涉及的角色主要包括：患者，访视医生，访视助理，系统管理员。针对各个角色的权限约束和主要业务的分析如下： 
### 患者：使用患者端，能完成访问自己的访视记录等实时记录和打印。 
### 访视助理：任务是在手术访视期间协助医生完成手术访视业务，记录访视结果和在本系统中录入。 
### 访视医生：任务是接受已经经过手术排班的患者数据信息，确认患者身份，选择患者进行线上进行手术访视，确保患者正常、安全、准确的进行手术访视；或线下根据医院的病房安排来推荐从入口到目标病房，相对较短的路段进行线下走访的访视；根据手术访视线上的会议或线下访视所需的科资料库，如访视期间所需的表单、访视期间所需的视频和访视科室所需的通知；在系统中流畅、安全的完成手术访视的记录的录入。
# 具体实现
## 患者管理
该业务主要完成访视医生在进行访视前对已经完成手术排班的患者，进行管理。完成可以根据患者的名字信息、设置访视时间段、麻醉医生姓名进行筛选，可以完成查看对应患者的基本信息、手术申请信息和手术排班信息。 该业务功能主要涉及的是对数据库的操作，如直接左连接表把整个表存储在列表中在给到dategriview组件，设置findal（l ）方法完成筛选；通过设置dategriview组件的 DoubleClick 方法，获取当前双击的对象，通过 Form 窗体带参数初始化传参，然后是根据对象的属性进行查找数据库显示患者详细信息的操作。 

该功能的流程如下： 
1. 访视医生首先进入系统的登录界面 
2. 在登录界面输入账号、密码和验证码信息登录手术麻醉管理系统 
3. 进入用户管理主界面，系统根据完成登录的账号信息识别是否又权限进入访
视系统。 
4. 如果有进入访视系统的权限，在点击患者管理菜单 
5. 在患者管理界面可以输入相关的筛选信息，点击筛选；支持筛选前直接双击
某条记录，也支持筛选后双击。 
6. 双击某记录后，可以查看该患者的详细信息。
## 线上会议
该业务主要完成访视医生对已经完成手术排班的患者进行访视创建线上会议的业务。可以完成根据访视科室患者信息实现患者卡片，也设置患者姓名、手术名进行筛选，可以完成线上创建单人或多人的预约线上会议。设置判断是否到预约会议的时间，提供进入、延迟、取消会议的提醒，进入会议（这里放在后面的访视库及监视会议开始模块详细说明）。 

该业务功能主要涉及的是数据库操作和线程。先把患者记录表左连接查询存储在对象列表中，列表转成数组，获取它的长度；根据数组和长度，第一层在数组内循环，第二层根据 Control 与 Controls 属性在窗体控件中循环，再判断它是否是 8 个患者卡片中的一个，如果是进行数组的显示数据；数据显示完或是窗体超过 8 个，对象 J 记录此时的第一层的数组数据索引，退出循环；和第二层循环同级，根据对象 J 来完成窗体的隐藏和窗体的显示。可以根据加减 8 个窗体，窗体恢复和改变了数组和长度的显示函数完成上下翻页操作。双击患者卡片使用列表记录双击时的数组索引，然后把双击的时候整个患者记录表和数组索引通过Form 初始化传参，记录该患者的信息。按照指引输入预约线上会议的相关信息，如：会议名、会议开始时间、会议结束时间、会议密码，完成创建会议。 

该功能的流程如下： 
1. 和患者管理功能业务流程的前三步一样 
2. 如果有进入访视系统的权限，在点击发起会议菜单 
3. 支持直接双击选中患者卡片，也支持先筛选再选中； 
4. 或单击多选后点击确定，再选择创建会议 
5. 根据需要输入会议主题和会议的开始时间和结束时间、会议密码然后预约会议。 
## 语音识别和检测功能业务
该功能业务主要是完成访视医生进入会议后对语音的管理，包括打开本系统语音、实时语音识别转为文字、根据文字进行语音检测、显示语音检测结果、关闭语音的业务功能。 
该业务功能主要涉及的是语音识别和语音检测。通过 VS2019 所支持的winmm.dll 包，通过调用它本身封装的方法可以进行调用 windows 系统音频功能，如：打开和关闭语音，保存录音和播放录音命令。 
目前的音频识别 ASR 系统由声学、发音和语言三个模型构成[13]。录制的语音经过系统的处理把音频里的噪声清除，在这个过程中可能丢失有用信号，再划分为小片段；把每个片段送到声学模型去检测，检测原理是将这些片段与现有的音素进行比较。基于这样的匹配，从音素中返回对应的单词或中文。本系统通过.Net4.0 框架所提供的 System.Speech 组件，windows 系统来识别我们的语音。 

根据本系统的使用背景，预先创建关键词语列表和增加违规词语的录入，增加识别效率。当点击开启语音按钮就开启获取所有语音引擎，选择默认的音频输入设备，初始化语音识别引擎，根据预先创建关键字数组建立本身带有的语音识别语法，加载自然语法；识别模式为连续识别启动语音识别函数，把结果返回。 当点击关闭语音为卸载自然语法，执行关闭语音识别函数。
## 图片识别功能业务 
该功能业务主要是完成访视医生进入会议后对图像的检测，包含了打开和关闭摄像头、拍图、存储图、每隔几秒拍图然后送到二维码检测、检测结果显示。 
该业务主要涉及图像处理和线程设置。基于 VS2019 软件提供的 Aforge 技术，完成打开本机摄像头的操作和显示在 videoSourcePlayer 控件上，也可以完成实时拍显示在 pictureBox1 上和通过文件的写入操作把该图片到文件夹；设置一个线程，定为每隔一秒执行一次，每次执行一次拍图和存储到变量里，送到图片识别类函数里识别，返回识别 bool 型结果，如果存在二维码就提示：“存在二维码违规操作！”并显示该图片在 pictureBox2 上记录次数+1，存储相应的违规图片，如果没有二维码什么都不做。 
图片二维码识别类主要是基于 VS2019 提供的类库 zxing.dll，来进行图片从Bitmap 的基类型到 byte[]字节类型的图片转换，规定传入图片的 width 和 height参数创建 LuminanceSource 对象，把该对象进行图片解码前的错误与处理位图图像的处理和创建 BinaryBitmap 对象，最后把 BinaryBitmap 进行解码返回界面的信息，根据返回的信息的长度是否=0，返回真或假，如图 5-2 所示
## 线下推荐最短路线功能业务
条件（预设计）： 
1. 先根据学校以前的 02 栋宿舍楼选择两层作为架构，按照图论进行标点从 0到 21 个点如图 5-2，并且规定每次从 0 点出发。 
2. 根据弗洛伊德算法录入点和对应的边，封装出（出发点，目的点）的函数twoPaint_Floydpath（）方法然后得到两点的最短路径。 
3. 两个哈希算法完成患者房间号通过哈希 H1 算法得到（0 到 21）数字，推荐路线处理后，数字通过哈希 H2 算法换回患者的房间号。
在创建会议的界面单击多选后确定，这里是用到一个列表把当时的数组索引存储和整个患者记录通过推荐路线界面的初始传参，在使用相同的方法显示在最多三个 3 卡片上，卡片上有记录每一个患者的房间。对单击选中的患者病房号通过哈希 H1 得到对应的数字。
采用分段优化思想。
（1）如果单击只选择了一个患者就直接调用一次的弗洛伊德算法，医生回来的路径可以选择原路返回或对调（出发点，目的点）再一次弗洛伊德算法函数twoPaint_Floydpath 方法后再通过哈希 H2 得到路经过的病房号序列输出； 

（2）如果是选择了两个患者（A，B），根据穷举法分析： 
根据分段优化的特点，第一步决定去到目的地的最短路径：因为（A，B）和（B，A）的距离一样，所以只需要确定（0，A）和（0，B）的距离就可以确定选择用情况一或情况二进而确定去的最短路径，但此时是逻辑数字编号还要经过哈希 H2 得到具体经过的病房号。第二步根据选择的情况一或情况二，再（B，0）或（A，0）用一次弗洛伊德算法，但此时是逻辑数字编号还要经过哈希 H2 得到具体经过的病房号。
（3）如果是选择了三个患者（A，B，C）根据树形穷举发如图决定去的最短路径：第一步，根据分段优化的特点，进行每一种情况的两两弗洛伊德得到六种情况的每一种情况的总路径的路径权值，选择最小的那一种情况，得到逻辑数字的最短路径。第二步，把得到逻辑数字的最短路径经过哈希 H2得到具体经过的病房号。 
决定回的最短路径：由于已经知道去的最短路径情况，所以肯定能知道是以A、B、C 那一个结尾，再进行一次弗洛伊德算法，得到回到的 0 逻辑数字的最
短路径。第二步，把得到逻辑数字的最短路径经过哈希 H2 得到具体经过的病房号。 
最后获取了相应患者的路径情况，关闭最短路径窗体后清空列表，卡片被选中的颜色恢复。
该功能的流程如下： 
1. 和发起会议功能业务流程的前两步一样。 
2. 单击选中患者卡片（一个、两个、三个）点击确定，点击推荐路线按钮，进入最短路径窗体。 
3. 最短路径窗体关闭。 
## 录入访视结果
## 等等
